package com.service;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.dingtalk.api.response.OapiProcessinstanceGetResponse;
import junit.framework.TestCase;

import java.time.LocalDate;

public class ApprovalServiceTest extends TestCase {

    private ApprovalService approvalService = new ApprovalService();

    public void testParseOutInstance() {
        // given
        OapiProcessinstanceGetResponse.ProcessInstanceTopVo instance = JSON.parseObject("{\"attachedProcessInstanceIds\":[],\"bizAction\":\"NONE\",\"businessId\":\"202010302255000312250\",\"createTime\":1604069732000,\"finishTime\":1604069742000,\"formComponentValues\":[{\"name\":\"外出\",\"value\":\"[{\\\"componentName\\\":\\\"DDSelectField\\\",\\\"componentType\\\":\\\"DDSelectField\\\",\\\"props\\\":{\\\"bizAlias\\\":\\\"type\\\",\\\"holidayOptions\\\":[],\\\"id\\\":\\\"DDSelectField-K2BO2D1A\\\",\\\"label\\\":\\\"外出类型\\\",\\\"required\\\":true}},{\\\"componentName\\\":\\\"DDDateField\\\",\\\"componentType\\\":\\\"DDDateField\\\",\\\"props\\\":{\\\"bizAlias\\\":\\\"startTime\\\",\\\"holidayOptions\\\":[],\\\"id\\\":\\\"DDDateField-K2BO2D1B\\\",\\\"label\\\":\\\"开始时间\\\",\\\"placeholder\\\":\\\"请选择\\\",\\\"required\\\":true},\\\"value\\\":\\\"2020-11-04\\\"},{\\\"componentName\\\":\\\"DDDateField\\\",\\\"componentType\\\":\\\"DDDateField\\\",\\\"props\\\":{\\\"bizAlias\\\":\\\"finishTime\\\",\\\"holidayOptions\\\":[],\\\"id\\\":\\\"DDDateField-K2BO2D1C\\\",\\\"label\\\":\\\"结束时间\\\",\\\"placeholder\\\":\\\"请选择\\\",\\\"required\\\":true},\\\"value\\\":\\\"2020-11-05\\\"},{\\\"componentName\\\":\\\"NumberField\\\",\\\"componentType\\\":\\\"NumberField\\\",\\\"extValue\\\":\\\"{\\\\\\\"compressedValue\\\\\\\":\\\\\\\"1f8b0800000000000000ad904f4bc34010c5bfcb9c57d9c46449722b06b1602f1a0f223d0cc9d62e6eb361ff2825e4bbbb1b6b08a55690ee6de6cdce7bf3eba146593b8996af54c3a1880834dca2900fc258285e7b689c462b54bb6c4bdcfb816b4ac9ac79af9c86221bbb1b8ed6696ea0e801bb4eeeefb4da556217f6329a24499ed1f0c8b75aa99996c5f141ab251af3c4ebb0df8c1178db2c6aad8cafbceeab93ff8c456d6773637dc27d581310e69187fb36280d27f0c1b5f16e50803f0f06025b34b721c634d1496c970d14571ed0a7d2efa52776d81be53f0982100c57a275366048323a904b224c6f58fc1bc29465ec3f0867fffe4038b95f18614a53760ee19a1c238c4f228cd8517bda92b359ffb9153e37948b17f0a99cd956f8e66b18be004300c4eb0e030000\\\\\\\",\\\\\\\"unit\\\\\\\":\\\\\\\"DAY\\\\\\\",\\\\\\\"extension\\\\\\\":\\\\\\\"{\\\\\\\\\\\\\\\"tag\\\\\\\\\\\\\\\":\\\\\\\\\\\\\\\"\\\\\\\\\\\\\\\"}\\\\\\\",\\\\\\\"_from\\\\\\\":\\\\\\\"2020-11-04\\\\\\\",\\\\\\\"pushTag\\\\\\\":\\\\\\\"\\\\\\\",\\\\\\\"detailList\\\\\\\":[{\\\\\\\"classInfo\\\\\\\":{\\\\\\\"hasClass\\\\\\\":false,\\\\\\\"sections\\\\\\\":[{\\\\\\\"endAcross\\\\\\\":0,\\\\\\\"startTime\\\\\\\":1604449800000,\\\\\\\"endTime\\\\\\\":1604482200000,\\\\\\\"startAcross\\\\\\\":0}]},\\\\\\\"workDate\\\\\\\":1604419200000,\\\\\\\"isRest\\\\\\\":false,\\\\\\\"workTimeMinutes\\\\\\\":480,\\\\\\\"approveInfo\\\\\\\":{\\\\\\\"fromAcross\\\\\\\":0,\\\\\\\"toAcross\\\\\\\":0,\\\\\\\"fromTime\\\\\\\":1604449800000,\\\\\\\"durationInDay\\\\\\\":1,\\\\\\\"toTime\\\\\\\":1604482200000,\\\\\\\"durationInHour\\\\\\\":8}},{\\\\\\\"classInfo\\\\\\\":{\\\\\\\"hasClass\\\\\\\":false,\\\\\\\"sections\\\\\\\":[{\\\\\\\"endAcross\\\\\\\":0,\\\\\\\"startTime\\\\\\\":1604536200000,\\\\\\\"endTime\\\\\\\":1604568600000,\\\\\\\"startAcross\\\\\\\":0}]},\\\\\\\"workDate\\\\\\\":1604505600000,\\\\\\\"isRest\\\\\\\":false,\\\\\\\"workTimeMinutes\\\\\\\":480,\\\\\\\"approveInfo\\\\\\\":{\\\\\\\"fromAcross\\\\\\\":0,\\\\\\\"toAcross\\\\\\\":0,\\\\\\\"fromTime\\\\\\\":1604536200000,\\\\\\\"durationInDay\\\\\\\":1,\\\\\\\"toTime\\\\\\\":1604568600000,\\\\\\\"durationInHour\\\\\\\":8}}],\\\\\\\"durationInDay\\\\\\\":2,\\\\\\\"_to\\\\\\\":\\\\\\\"2020-11-05\\\\\\\",\\\\\\\"isModifiable\\\\\\\":true,\\\\\\\"durationInHour\\\\\\\":16}\\\",\\\"props\\\":{\\\"bizAlias\\\":\\\"duration\\\",\\\"disable\\\":true,\\\"holidayOptions\\\":[],\\\"id\\\":\\\"NumberField-K2BO2D1D\\\",\\\"label\\\":\\\"时长\\\",\\\"placeholder\\\":\\\"请输入时长\\\",\\\"required\\\":true},\\\"value\\\":\\\"2\\\"}]\"},{\"name\":\"外出事由\",\"value\":\"测试集成\"},{\"name\":\"图片\",\"value\":\"null\"},{\"value\":\"如何设置审批人？\\n了解详情>>\"},{\"extValue\":\"{\\\"compressedValue\\\":\\\"1f8b0800000000000000ad904f4bc34010c5bfcb9c57d9c46449722b06b1602f1a0f223d0cc9d62e6eb361ff2825e4bbbb1b6b08a55690ee6de6cdce7bf3eba146593b8996af54c3a1880834dca2900fc258285e7b689c462b54bb6c4bdcfb816b4ac9ac79af9c86221bbb1b8ed6696ea0e801bb4eeeefb4da556217f6329a24499ed1f0c8b75aa99996c5f141ab251af3c4ebb0df8c1178db2c6aad8cafbceeab93ff8c456d6773637dc27d581310e69187fb36280d27f0c1b5f16e50803f0f06025b34b721c634d1496c970d14571ed0a7d2efa52776d81be53f0982100c57a275366048323a904b224c6f58fc1bc29465ec3f0867fffe4038b95f18614a53760ee19a1c238c4f228cd8517bda92b359ffb9153e37948b17f0a99cd956f8e66b18be004300c4eb0e030000\\\",\\\"unit\\\":\\\"DAY\\\",\\\"extension\\\":\\\"{\\\\\\\"tag\\\\\\\":\\\\\\\"\\\\\\\"}\\\",\\\"_from\\\":\\\"2020-11-04\\\",\\\"pushTag\\\":\\\"\\\",\\\"detailList\\\":[{\\\"classInfo\\\":{\\\"hasClass\\\":false,\\\"sections\\\":[{\\\"endAcross\\\":0,\\\"startTime\\\":1604449800000,\\\"endTime\\\":1604482200000,\\\"startAcross\\\":0}]},\\\"workDate\\\":1604419200000,\\\"isRest\\\":false,\\\"workTimeMinutes\\\":480,\\\"approveInfo\\\":{\\\"fromAcross\\\":0,\\\"toAcross\\\":0,\\\"fromTime\\\":1604449800000,\\\"durationInDay\\\":1,\\\"toTime\\\":1604482200000,\\\"durationInHour\\\":8}},{\\\"classInfo\\\":{\\\"hasClass\\\":false,\\\"sections\\\":[{\\\"endAcross\\\":0,\\\"startTime\\\":1604536200000,\\\"endTime\\\":1604568600000,\\\"startAcross\\\":0}]},\\\"workDate\\\":1604505600000,\\\"isRest\\\":false,\\\"workTimeMinutes\\\":480,\\\"approveInfo\\\":{\\\"fromAcross\\\":0,\\\"toAcross\\\":0,\\\"fromTime\\\":1604536200000,\\\"durationInDay\\\":1,\\\"toTime\\\":1604568600000,\\\"durationInHour\\\":8}}],\\\"durationInDay\\\":2,\\\"_to\\\":\\\"2020-11-05\\\",\\\"isModifiable\\\":true,\\\"durationInHour\\\":16}\",\"name\":\"[\\\"开始时间\\\",\\\"结束时间\\\"]\",\"value\":\"[\\\"2020-11-04\\\",\\\"2020-11-05\\\",2.0,\\\"day\\\",\\\"\\\",\\\"外出类型\\\"]\"}],\"operationRecords\":[{\"date\":1604069731000,\"operationResult\":\"NONE\",\"operationType\":\"START_PROCESS_INSTANCE\",\"userid\":\"263444381429570456\"},{\"date\":1604069741000,\"operationResult\":\"AGREE\",\"operationType\":\"EXECUTE_TASK_NORMAL\",\"remark\":\"\",\"userid\":\"263444381429570456\"}],\"originatorDeptId\":\"-1\",\"originatorDeptName\":\"测试钉钉集成\",\"originatorUserid\":\"263444381429570456\",\"result\":\"agree\",\"status\":\"COMPLETED\",\"tasks\":[{\"createTime\":1604069732000,\"finishTime\":1604069742000,\"taskResult\":\"AGREE\",\"taskStatus\":\"COMPLETED\",\"taskid\":\"66034300552\",\"userid\":\"263444381429570456\"}],\"title\":\"王许超提交的外出\"}", OapiProcessinstanceGetResponse.ProcessInstanceTopVo.class);

        // when
        approvalService.parseOutInstance(instance);
    }

    public void testParseFormComponent() {
        LocalDate startTime = null;
        LocalDate endTime = null;

        JSONArray outSuite = JSON.parseArray("[{\"componentName\":\"DDSelectField\",\"componentType\":\"DDSelectField\",\"props\":{\"bizAlias\":\"type\",\"holidayOptions\":[],\"id\":\"DDSelectField-K2BO2D1A\",\"label\":\"外出类型\",\"required\":true}},{\"componentName\":\"DDDateField\",\"componentType\":\"DDDateField\",\"props\":{\"bizAlias\":\"startTime\",\"holidayOptions\":[],\"id\":\"DDDateField-K2BO2D1B\",\"label\":\"开始时间\",\"placeholder\":\"请选择\",\"required\":true},\"value\":\"2020-10-23\"},{\"componentName\":\"DDDateField\",\"componentType\":\"DDDateField\",\"props\":{\"bizAlias\":\"finishTime\",\"holidayOptions\":[],\"id\":\"DDDateField-K2BO2D1C\",\"label\":\"结束时间\",\"placeholder\":\"请选择\",\"required\":true},\"value\":\"2020-10-24\"},{\"componentName\":\"NumberField\",\"componentType\":\"NumberField\",\"extValue\":\"{\\\"compressedValue\\\":\\\"1f8b0800000000000000ad904f4bc34010c5bfcb9c57499a346c722b06b1602f1a0f223d0cc9d62e6e77c3fe514ac8777737b525945841bab799373befcdaf831a45ed045ab6520d832226d0308b5c3c7263a178eba0711a2d5772294bdcfb81db2822a3e683721a0a3a74370cadd3cc40d101b6add8df6bb5abf82eeccda2248d936878e4a0566aa4a5f3f447ab051af3cceab0df0c11986c16b556c6575ef7d5e43f6351dbd1dc504fb8f76b02dc3cb170df068561043e9936de0d0af0e7414f608be62ec4384db402e5b281e2c603fa52faa3f4c40e7b133a3b260842305c71e96cc090d2a827574598e7e96f08e7494cff8370f4ef2f8447f72b234c334a2f215c937384b349847176d63e6dc9b351ff45729f1bcac52bf854ce6c2b7cf735f4df785133dd0e030000\\\",\\\"unit\\\":\\\"DAY\\\",\\\"extension\\\":\\\"{\\\\\\\"tag\\\\\\\":\\\\\\\"\\\\\\\"}\\\",\\\"_from\\\":\\\"2020-10-23\\\",\\\"pushTag\\\":\\\"\\\",\\\"detailList\\\":[{\\\"classInfo\\\":{\\\"hasClass\\\":false,\\\"sections\\\":[{\\\"endAcross\\\":0,\\\"startTime\\\":1603413000000,\\\"endTime\\\":1603445400000,\\\"startAcross\\\":0}]},\\\"workDate\\\":1603382400000,\\\"isRest\\\":false,\\\"workTimeMinutes\\\":480,\\\"approveInfo\\\":{\\\"fromAcross\\\":0,\\\"toAcross\\\":0,\\\"fromTime\\\":1603413000000,\\\"durationInDay\\\":1,\\\"toTime\\\":1603445400000,\\\"durationInHour\\\":8}},{\\\"classInfo\\\":{\\\"hasClass\\\":false,\\\"sections\\\":[{\\\"endAcross\\\":0,\\\"startTime\\\":1603499400000,\\\"endTime\\\":1603531800000,\\\"startAcross\\\":0}]},\\\"workDate\\\":1603468800000,\\\"isRest\\\":false,\\\"workTimeMinutes\\\":480,\\\"approveInfo\\\":{\\\"fromAcross\\\":0,\\\"toAcross\\\":0,\\\"fromTime\\\":1603499400000,\\\"durationInDay\\\":1,\\\"toTime\\\":1603531800000,\\\"durationInHour\\\":8}}],\\\"durationInDay\\\":2,\\\"_to\\\":\\\"2020-10-24\\\",\\\"isModifiable\\\":true,\\\"durationInHour\\\":16}\",\"props\":{\"bizAlias\":\"duration\",\"disable\":true,\"holidayOptions\":[],\"id\":\"NumberField-K2BO2D1D\",\"label\":\"时长\",\"placeholder\":\"请输入时长\",\"required\":true},\"value\":\"2\"}]");
        for (int i = 0; i < outSuite.size(); i++) {
            JSONObject item = outSuite.getJSONObject(i);
            JSONObject props = item.getJSONObject("props");
            String label = props.getString("label");
            if (label.equals("开始时间")) {
                String itemValue = item.getString("value");
                startTime = LocalDate.parse(itemValue);
            } else if (label.equals("结束时间")) {
                String itemValue = item.getString("value");
                endTime = LocalDate.parse(itemValue);
            }
        }
    }
}